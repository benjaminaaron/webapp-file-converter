<!doctype html>
<html>
    <head>
        <title>webapp file converter</title>
        <meta charset="UTF-8">
        
        <!-- vendors -->
        <script src="js/vendors/jquery-2.1.4.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="js/vendors/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
        <link href="css/vendors/jquery-ui.min.css" rel="stylesheet" type="text/css">
        
        <script src="js/vendors/CSVToArray.js" type="text/javascript" charset="utf-8"></script>

        <!-- selfmade converters -->
        <script src="js/RedmineParser.js" type="text/javascript" charset="utf-8"></script>
        <script src="js/GraphmlExporter.js" type="text/javascript" charset="utf-8"></script>

        <style>    
            html * {
                font-family: Georgia, serif;
            }
            a {
                text-decoration: none;
                color: #bbb;
                background-color: #eee;
            }
            #dropzone {
                width: 400px;
                margin: 0 auto;
                border: 2px dashed #bbb;
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                border-radius: 5px;
                padding: 25px;
                text-align: center;
                font: 20pt bold 'Vollkorn';
                color: #bbb;
            }
            .info {
                text-align: center;
                color: #ccc;
            }
            img {
                display: block;
                margin-left: auto;
                margin-right: auto;
                height: auto;
            }
            #conversionModeSelector {
                display: table;
                margin: 0 auto;
            }
            .inactive {
                color: #ccc
            }
            select {
                color: #009
            }
        </style>
    </head>
    <body>
        <br><br>
        <img width="200px" src="files/meme.jpg">
        <br><br>
        <div id="dropzone">drop file here</div> <!-- via www.html5rocks.com/en/tutorials/file/dndfiles -->
        <br><br>
        <select id="conversionModeSelector">
            <option value="redmineIssuesCSV-graphml">redmine issues csv &nbsp;&rarr;&nbsp; graphml</option>
            <option class="inactive" value="csv-xml">csv &nbsp;&rarr;&nbsp; xml</option>
            <option class="inactive" value="json-xml">json &nbsp;&rarr;&nbsp; xml</option>
            <option class="inactive" value="xml-csv">xml &nbsp;&rarr;&nbsp; csv</option>
            <option class="inactive" value="xml-json">xml &nbsp;&rarr;&nbsp; json</option>
        </select>        
        <!--<br><br><img id="getLink" width="25px" src="files/getLink.png">-->
        <br><br>
        <div class="info">
            the file will be converted and "downloaded" (no upload, all happens locally) right away
        </div>
        <div class="info"><small>
            tested successfully on Chrome and Firefox (don't drag and drop too fast), doesn't work on Safari at the moment
        </small></div>

        <script>
    
            var domain = window.location.href;
            var converters = [];
            converters['redmineIssuesCSV-graphml'] = new RedmineParser();
            var converter = converters[$('#conversionModeSelector').val()];
                                
            $('#getLink').on('click', function (e) {       
                alert(domain + '?' + conversionMode);
            });
        
            $('#conversionModeSelector').on('change', function (e) {
                var conversionMode = $(this).val();    
                if(converters[conversionMode]){
                    converter = converters[conversionMode];
                }
                else {
                    alert('This converter isn\'t implemented yet.');
                    //TODO set selector back to fallback
                }
            });
            
            var urlParams = window.location.search;
            
            if(urlParams.length > 0){
                domain = domain.substring(0, domain.length - urlParams.length);
                urlParams = urlParams.substring(1, urlParams.length);
                sourceFormat = urlParams.split('-')[0];
                targetFormat = urlParams.split('-')[1];
                $('#sourceFormatSelector').val(sourceFormat);
                $('#targetFormatSelector').val(targetFormat);
            }

            var filecontent = '';

            var dropzone = document.getElementById('dropzone');
            dropzone.addEventListener('dragover', handleDragOver, false);
            dropzone.addEventListener('drop', handleFileSelect, false);
        
            function handleDragOver(evt) {
                evt.stopPropagation();
                evt.preventDefault();
                evt.dataTransfer.dropEffect = 'copy';
            };

            function handleFileSelect(evt) {                 
                $('#dropzone').effect('highlight', {}, 1200);
                evt.stopPropagation();
                evt.preventDefault();
                var file = evt.dataTransfer.files[0];
                //console.log(file.name + ' / ' + file.type + ' / ' + file.size + ' / ' + file.lastModifiedDate);
                
                var fileOK = true; //TODO
                /*
                var fileOK = sourceFormat == '*' ? true : false;
                var filenameParts = file.name.split('\.');
                if(!fileOK && filenameParts.length > 0)
                    if(filenameParts[filenameParts.length - 1] == sourceFormat)
                        fileOK = true;
                */
                                                
                if(fileOK){
                    var reader = new FileReader();
                    reader.onload = (function() {
                        return function(e) {
                            filecontent = e.target.result;
                            processFile();
                        };
                    })();
                    reader.readAsText(file);
                }
                else {
                    alert('that\'s not a .' + sourceFormat + ' file');
                }
            };

            function processFile(){                
                switch(sourceFormat + '_' + targetFormat) {
                  case 'redmine-issues-csv_graphml':
                      
                      var rp = new RedmineParser();                  
                      rp.readFile(filecontent);
                      
                      break;
                  default:
                      alert('conversion not implemented yet');
              }
                
                //download(filecontent, 'converted_file.' + targetFormat);
            };
            
            function download(content, filename){
                var element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

        </script>
    </body>
</html>
